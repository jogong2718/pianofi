services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile.dev
    image: pianofi-backend:dev
    ports:
      - "8000:8000"
    env_file:
      - packages/pianofi_config/.env
    volumes:
      - ./uploads:/app/uploads
      # - ./backend/app:/app/app
      - ./project-aws:/root/.aws
    develop:
      watch:
        - action: sync
          path: ./backend/app
          target: /app/app
        - action: rebuild
          path: ./Dockerfile.dev
    restart: unless-stopped
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    image: pianofi-frontend:dev
    ports:
      - "3000:3000"
    env_file:
      - frontend/.env.local
    environment:
      - NEXT_PUBLIC_BACKEND_URL=http://localhost:8000  # âœ… Use service name
    volumes:
      # - ./frontend:/app
      # - /app/node_modules  # Prevent overwriting node_modules
      - /app/.next
    develop:
      watch:
        - action: sync
          path: ./frontend
          target: /app
          ignore:
            - node_modules/
            - .next/
        - action: rebuild
          path: ./frontend/Dockerfile.dev
    depends_on:
      - backend
  picogenworker:
    build:
      context: .
      dockerfile: picogenworkers/Dockerfile
    image: pianofi-picogen-worker:dev
    env_file:
      - packages/pianofi_config/.env
    volumes:
      - ./uploads:/app/uploads     # host:container
      # - ./workers:/app/workers
      - ./project-aws:/home/picogen2/.aws
    develop:
      watch:
        - path: ./picogenworkers
          target: /app/picogenworkers
          action: sync
    # entrypoint: ""
    # command: tail -f /dev/null
    restart: unless-stopped
    # needs gpu
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
  amtworker:
    build:
      context: .
      dockerfile: amtworkers/Dockerfile
    image: pianofi-amt-worker:dev
    env_file:
      - packages/pianofi_config/.env
    volumes:
      - ./uploads:/app/uploads     # host:container
      # - ./workers:/app/workers
      - ./project-aws:/root/.aws
    develop:
      watch:
        - path: ./amtworkers
          target: /app/amtworkers
          action: sync
    # entrypoint: ""
    # command: tail -f /dev/null
    restart: unless-stopped
    # needs gpu
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
  basicpitchworker:
    build:
      context: .
      dockerfile: basicpitchworkers/Dockerfile
    image: pianofi-basicpitch-worker:dev
    env_file:
      - packages/pianofi_config/.env
    volumes:
      - ./uploads:/app/uploads     # host:container
      # - ./workers:/app/workers
      - ./project-aws:/root/.aws
    develop:
      watch:
        - path: ./basicpitchworkers
          target: /app/basicpitchworkers
          action: sync
    # entrypoint: ""
    # command: tail -f /dev/null
    restart: unless-stopped
    # needs gpu
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]